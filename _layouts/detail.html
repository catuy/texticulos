<!doctype html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {%- seo -%}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'IBM Plex Sans', sans-serif;
        }
        /* Subrayar enlaces en el contenido del detalle */
        .detail-content a {
            text-decoration: underline;
        }
        /* Agregar espacio entre p√°rrafos en el contenido */
        .detail-content p {
            margin-bottom: 1rem;
        }
    </style>
    {%- feed_meta -%}
  </head>
  <body class="bg-[#f8f9fe] min-h-screen w-full">
    <!-- Custom header for detail view -->
    <div class="relative px-0 py-[21px] mb-[8px]">
      <div class="px-[21px]">
        <a href="{{ site.baseurl }}/" class="text-[16px] text-black inline-flex items-center gap-2 hover:underline transition-all duration-200">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Volver
        </a>
      </div>
    </div>

    <main class="px-0">
      <!-- Text content - 1/3 width -->
      <div class="w-1/3 px-[21px] text-[16px] prose prose-sm detail-content">
        <!-- <h1 class="text-[16px] mb-4">{{ page.title }}</h1> -->
        {{ content }}
        <p class="mt-4">{{ page.year }} - {{ page.category }}</p>
      </div>
    </main>

    {%- include footer.html -%}

    <script>
      // SPA-like navigation for smooth audio persistence (copied from default.html)
      function initSPANavigation() {
        // Get current origin for checking internal links
        const currentOrigin = window.location.origin;

        // Function to reinitialize page-specific functionality after content load
        function reinitializePageEvents() {
          // Re-attach SPA navigation to new links
          attachSPAListeners();
        }

        // Function to load a page via AJAX
        function loadPage(url) {
          fetch(url)
            .then(response => response.text())
            .then(html => {
              // Parse the HTML
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');

              // Check current and new page types
              const currentHasCustomHeader = document.querySelector('body > div.relative');
              const newBody = doc.querySelector('body');
              const newHasCustomHeader = doc.querySelector('body > div.relative');

              // Always replace entire body if transitioning between different layouts
              // or if current page is detail (to clean up images/videos)
              if (newHasCustomHeader || currentHasCustomHeader) {
                // Replace entire body content
                const currentBody = document.querySelector('body');

                // Replace body content
                currentBody.innerHTML = newBody.innerHTML;

                // Update page title
                const newTitle = doc.querySelector('title');
                if (newTitle) {
                  document.title = newTitle.textContent;
                }

                // Scroll to top
                window.scrollTo(0, 0);

                // Reinitialize events (don't re-execute scripts to avoid variable redeclaration errors)
                reinitializePageEvents();

              } else {
                // Both are standard pages: replace just main content (more efficient)
                const newMain = doc.querySelector('main');
                const currentMain = document.querySelector('main');

                if (newMain && currentMain) {
                  // Replace main content
                  currentMain.innerHTML = newMain.innerHTML;

                  // Update page title
                  const newTitle = doc.querySelector('title');
                  if (newTitle) {
                    document.title = newTitle.textContent;
                  }

                  // Scroll to top
                  window.scrollTo(0, 0);

                  // Reinitialize events for new content
                  reinitializePageEvents();
                }
              }
            })
            .catch(error => {
              console.error('Error loading page:', error);
              // Fallback to normal navigation
              window.location.href = url;
            });
        }

        // Function to attach SPA listeners to links
        function attachSPAListeners() {
          const links = document.querySelectorAll('a[href]');

          links.forEach(link => {
            // Check if it's an internal link
            const href = link.getAttribute('href');

            // Skip if already has SPA listener
            if (link.hasAttribute('data-spa-attached')) return;

            // Skip links with onclick (category filters)
            if (link.hasAttribute('onclick')) return;

            // Only handle internal links (same origin, not external, not anchors, not files)
            if (href &&
                !href.startsWith('http') &&
                !href.startsWith('#') &&
                !href.startsWith('mailto:') &&
                !href.startsWith('tel:') &&
                !href.endsWith('.pdf') &&
                !href.endsWith('.zip')) {

              link.setAttribute('data-spa-attached', 'true');

              link.addEventListener('click', function(e) {
                e.preventDefault();

                const targetUrl = this.href;

                // Update browser history
                history.pushState({}, '', targetUrl);

                // Load the new page
                loadPage(targetUrl);
              });
            }
          });
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(e) {
          loadPage(window.location.href);
        });

        // Push initial state to history for proper back button support
        if (!window.history.state) {
          history.replaceState({ url: window.location.href }, '', window.location.href);
        }

        // Initialize on page load
        attachSPAListeners();
      }

      // Initialize SPA navigation when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        initSPANavigation();
      });
    </script>

    <!-- Media display -->
    {% if page.portada %}
      {% if page.category == "Video" %}
        {% assign video_filename = page.portada | replace: 'assets/videos/', '' | replace: '_frame.webp', '.mp4' %}
        <video controls preload="metadata" poster="{{ page.portada | relative_url }}" class="fixed bottom-0 right-0 object-contain w-2/3 h-auto" style="z-index: 50;" crossorigin="anonymous">
          <source src="{{ site.baseurl }}/assets/videos/{{ video_filename }}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      {% else %}
        <img src="{{ page.portada | relative_url }}" alt="Portada de {{ page.title }}" onload="adjustImageSize(this)" class="fixed bottom-0 right-0 object-contain -z-10">
      {% endif %}
    {% endif %}

    <script>
      function adjustImageSize(img) {
        if (img.naturalHeight > img.naturalWidth) {
          img.classList.add('h-screen', 'w-auto');
          img.classList.remove('w-2/3', 'h-auto');
        } else {
          img.classList.add('w-2/3', 'h-auto');
          img.classList.remove('h-screen', 'w-auto');
        }
      }

      // Video sizing and aspect ratio handling
      // Execute immediately (not waiting for DOMContentLoaded) so it works in SPA navigation
      (function() {
        const video = document.querySelector('video');
        if (video) {
          // Function to apply sizing based on video dimensions
          function applyVideoSizing() {
            if (video.videoWidth && video.videoHeight) {
              console.log('Video loaded:', video.videoWidth, 'x', video.videoHeight);

              // Apply same sizing logic as images
              if (video.videoHeight > video.videoWidth) {
                // Portrait video: full height like portrait images
                video.classList.add('h-screen', 'w-auto');
                video.classList.remove('w-2/3', 'h-auto');
                console.log('Applied portrait sizing: h-screen w-auto');
              } else {
                // Landscape video: 2/3 width like landscape images
                video.classList.add('w-2/3', 'h-auto');
                video.classList.remove('h-screen', 'w-auto');
                console.log('Applied landscape sizing: w-2/3 h-auto');
              }
              return true;
            }
            return false;
          }

          // Try to apply sizing immediately if metadata is already loaded
          if (!applyVideoSizing()) {
            // If not loaded yet, wait for metadata
            video.addEventListener('loadedmetadata', applyVideoSizing);
            
            // Multiple fallback attempts for SPA navigation
            // Try at 50ms, 150ms, 300ms, and 500ms
            [50, 150, 300, 500].forEach(function(delay) {
              setTimeout(function() {
                if (video.videoWidth && video.videoHeight) {
                  applyVideoSizing();
                }
              }, delay);
            });
          }

          // Handle potential playback issues
          video.addEventListener('error', function(e) {
            const error = video.error;
            console.error('Video error:', {
              code: error ? error.code : 'Unknown',
              message: error ? error.message : 'No error details',
              videoSrc: video.currentSrc,
              networkState: video.networkState,
              readyState: video.readyState,
              event: e
            });
          });

          // Improve video loading and playback
          video.addEventListener('loadstart', function() {
            console.log('Video load started');
          });

          video.addEventListener('canplay', function() {
            console.log('Video can play');
          });

          video.addEventListener('play', function() {
            console.log('Video started playing');
          });

          video.addEventListener('pause', function() {
            console.log('Video paused');
          });

          // Handle seeking events
          video.addEventListener('seeking', function() {
            console.log('Video seeking to:', video.currentTime);
          });

          video.addEventListener('seeked', function() {
            console.log('Video seeked to:', video.currentTime);
          });

          // Ensure video is seekable
          video.addEventListener('canplay', function() {
            console.log('Video duration:', video.duration);
            console.log('Video seekable:', video.seekable);
            if (video.seekable.length > 0) {
              console.log('Seekable range:', video.seekable.start(0), 'to', video.seekable.end(0));
            }
          });
        }
      })(); // Execute immediately
    </script>
  </body>
</html>
